import{r as t}from"./react-2981e50d.js";import{A as e}from"./accountService-f5f42876.js";import{d as i}from"./index-e48b942e.js";import{P as s}from"./portfolioService-309953aa.js";function a({title:e,titleId:i,...s},a){return t.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":i},s),e?t.createElement("title",{id:i},e):null,t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"}))}const n=t.forwardRef(a);function o({title:e,titleId:i,...s},a){return t.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":i},s),e?t.createElement("title",{id:i},e):null,t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"}))}const r=t.forwardRef(o);function c({title:e,titleId:i,...s},a){return t.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true","data-slot":"icon",ref:a,"aria-labelledby":i},s),e?t.createElement("title",{id:i},e):null,t.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"}))}const l=t.forwardRef(c);class u{static async getOrCreateRules(t){let e=await i.getInvestmentRules(t);return e||(e=await i.createDefaultInvestmentRules(t)),e}static async updateRules(t,e){const s=await this.getOrCreateRules(t);await i.updateInvestmentRules(s.id,e)}static async analyzePortfolioRisk(t){const[e,i,a,n]=await Promise.all([s.getById(t),s.getWithPositions(t).then(t=>t.positions),this.getOrCreateRules(t),this.getCashBalance(t)]);if(!e)throw new Error("포트폴리오를 찾을 수 없습니다.");const o=[],r=[],c=this.analyzeConcentrationRisk(i,e,a);o.push(...this.generateConcentrationWarnings(c,a));const l=this.analyzeCashRisk(n,a);o.push(...this.generateCashWarnings(l,a));const u=this.analyzePositionRisks(i,a);o.push(...this.generatePositionWarnings(u,a));const m=this.calculateOverallRiskScore(c,l,u);return r.push(...this.generateRecommendations(m,c,l)),{portfolioId:t,riskScore:m,warnings:o.sort((t,e)=>this.getWarningPriority(t.type)-this.getWarningPriority(e.type)),recommendations:r,concentrationRisk:c,cashRisk:l,positionRisks:u,analysisDate:Date.now()}}static async createInvestmentChecklist(t,e,i){const[a,n,o,r,c]=await Promise.all([s.getById(t),s.getWithPositions(t).then(t=>t.positions),this.getOrCreateRules(t),this.getCashBalance(t),this.analyzePortfolioRisk(t)]);if(!a)throw new Error("포트폴리오를 찾을 수 없습니다.");const l=[],u=[],m=this.checkCashAvailability(r,i,o);l.push(m),"WARNING"!==m.status&&"FAIL"!==m.status||u.push(this.createWarningFromCheck(m));const h=this.checkPositionSize(n,e,i,a,o);l.push(h),"WARNING"!==h.status&&"FAIL"!==h.status||u.push(this.createWarningFromCheck(h));const g=await this.checkInvestmentLimits(t,i,o);l.push(g),"WARNING"!==g.status&&"FAIL"!==g.status||u.push(this.createWarningFromCheck(g));const d=this.checkCooldownPeriod(n,e,o);l.push(d),"WARNING"!==d.status&&"FAIL"!==d.status||u.push(this.createWarningFromCheck(d));const k=this.checkConsecutiveLosses(n,e,o);l.push(k),"WARNING"!==k.status&&"FAIL"!==k.status||u.push(this.createWarningFromCheck(k));const I=this.checkPortfolioRisk(c,o);l.push(I),"WARNING"!==I.status&&"FAIL"!==I.status||u.push(this.createWarningFromCheck(I));const y=l.filter(t=>"FAIL"===t.status&&t.isBlocking),p=l.filter(t=>"WARNING"===t.status);return{portfolioId:t,symbol:e,plannedAmount:i,checks:l,overallRisk:y.length>0||p.length>2?"HIGH":p.length>0?"MEDIUM":"LOW",canProceed:0===y.length,warnings:u}}static analyzeConcentrationRisk(t,e,i){const s=t.reduce((t,e)=>t+e.quantity*e.currentPrice,0);return{topPositions:t.map(t=>{const e=t.quantity*t.currentPrice,a=s>0?e/s*100:0;return{symbol:t.symbol,name:t.name,percentage:a,risk:a>i.maxPositionSize?"HIGH":a>.8*i.maxPositionSize?"MEDIUM":"LOW"}}).sort((t,e)=>e.percentage-t.percentage).slice(0,5),sectorConcentration:this.analyzeSectorConcentration(t,s),diversificationScore:this.calculateDiversificationScore(t)}}static analyzeCashRisk(t,e){if(!t)return{currentCashRatio:0,recommendedCashRatio:e.minCashReserve,utilizationRate:100,risk:"HIGH",daysUntilCashOut:0};const i=t.cashBalance/t.totalBalance*100,s=i<e.minCashReserve?"HIGH":i<1.5*e.minCashReserve?"MEDIUM":"LOW",a=e.maxDailyInvestment||1e5,n=Math.floor(t.cashBalance/a);return{currentCashRatio:i,recommendedCashRatio:e.minCashReserve,utilizationRate:t.utilizationRate,risk:s,daysUntilCashOut:n}}static analyzePositionRisks(t,e){return t.map(t=>{const i=(t.currentPrice-t.avgPrice)/t.avgPrice*100,s=[];t.quantity*t.currentPrice>e.maxPositionAmount&&s.push(`최대 포지션 금액 초과 (${e.maxPositionAmount.toLocaleString()}원)`);let a=5;return i<-e.stopLossPercentage&&(a+=2),i<-20&&(a+=2),s.length>0&&(a+=1),{positionId:t.id,symbol:t.symbol,name:t.name,currentReturn:i,riskScore:Math.min(10,Math.max(1,a)),consecutiveLosses:0,lastTradeDate:t.tradeDate,violatesRules:s}})}static async getCashBalance(t){const i=await s.getById(t);return i?await e.getCashBalance(i.accountId):null}static checkCashAvailability(t,e,i){if(!t)return{id:"cash-availability",category:"CASH",title:"현금 잔고 확인",status:"FAIL",message:"현금 잔고 정보를 찾을 수 없습니다.",isBlocking:!0};if(e>t.cashBalance)return{id:"cash-availability",category:"CASH",title:"현금 잔고 확인",status:"FAIL",message:`현금 잔고(${t.cashBalance.toLocaleString()}원)가 부족합니다.`,recommendation:"투자 금액을 줄이거나 현금을 추가 입금하세요.",isBlocking:!0};const s=(t.cashBalance-e)/t.totalBalance*100;return s<i.minCashReserve?{id:"cash-availability",category:"CASH",title:"현금 잔고 확인",status:"WARNING",message:`투자 후 현금 비율이 ${s.toFixed(1)}%로 권장 비율(${i.minCashReserve}%) 미만입니다.`,recommendation:"비상 자금 확보를 위해 현금 비율을 유지하는 것이 좋습니다.",isBlocking:!1}:{id:"cash-availability",category:"CASH",title:"현금 잔고 확인",status:"PASS",message:"충분한 현금 잔고가 확보되어 있습니다.",isBlocking:!1}}static checkPositionSize(t,e,i,s,a){const n=t.find(t=>t.symbol===e),o=t.reduce((t,e)=>t+e.quantity*e.currentPrice,0)+i,r=(n?n.quantity*n.currentPrice:0)+i,c=r/o*100;return r>a.maxPositionAmount?{id:"position-size",category:"POSITION",title:"포지션 크기 확인",status:"FAIL",message:`단일 종목 최대 금액(${a.maxPositionAmount.toLocaleString()}원)을 초과합니다.`,recommendation:"투자 금액을 줄이거나 포지션 한도를 조정하세요.",isBlocking:!0}:c>a.maxPositionSize?{id:"position-size",category:"POSITION",title:"포지션 크기 확인",status:"WARNING",message:`단일 종목 최대 비중(${a.maxPositionSize}%)을 초과할 수 있습니다.`,recommendation:"포트폴리오 집중도를 낮추기 위해 투자 금액을 조정하세요.",isBlocking:!1}:{id:"position-size",category:"POSITION",title:"포지션 크기 확인",status:"PASS",message:"적절한 포지션 크기입니다.",isBlocking:!1}}static async checkInvestmentLimits(t,e,i){return e>i.maxDailyInvestment?{id:"investment-limits",category:"RULES",title:"투자 한도 확인",status:"WARNING",message:`일일 투자 한도(${i.maxDailyInvestment.toLocaleString()}원)를 초과합니다.`,recommendation:"투자 금액을 분할하여 여러 날에 걸쳐 진행하세요.",isBlocking:!1}:{id:"investment-limits",category:"RULES",title:"투자 한도 확인",status:"PASS",message:"투자 한도 내에서 진행됩니다.",isBlocking:!1}}static checkCooldownPeriod(t,e,i){const s=t.find(t=>t.symbol===e);if(s){const t=(Date.now()-s.tradeDate)/36e5;if(t<i.cooldownPeriod){return{id:"cooldown-period",category:"RULES",title:"재매수 대기 시간",status:"WARNING",message:`동일 종목 재매수까지 ${Math.ceil(i.cooldownPeriod-t)}시간 남았습니다.`,recommendation:"충분한 시간을 두고 재매수를 진행하세요.",isBlocking:!1}}}return{id:"cooldown-period",category:"RULES",title:"재매수 대기 시간",status:"PASS",message:"재매수 대기 시간이 충족되었습니다.",isBlocking:!1}}static checkConsecutiveLosses(t,e,i){const s=t.find(t=>t.symbol===e);if(s){const t=(s.currentPrice-s.avgPrice)/s.avgPrice*100;if(t<-i.stopLossPercentage)return{id:"consecutive-losses",category:"POSITION",title:"손실 상황 확인",status:"WARNING",message:`현재 ${Math.abs(t).toFixed(1)}% 손실 상태입니다.`,recommendation:"손절 기준을 검토하고 추가 매수를 신중히 결정하세요.",isBlocking:!1}}return{id:"consecutive-losses",category:"POSITION",title:"손실 상황 확인",status:"PASS",message:"손실 기준 내에서 관리되고 있습니다.",isBlocking:!1}}static checkPortfolioRisk(t,e){return t.riskScore>e.maxPortfolioRisk?{id:"portfolio-risk",category:"PORTFOLIO",title:"포트폴리오 위험도",status:"WARNING",message:`포트폴리오 위험도(${t.riskScore})가 허용 기준(${e.maxPortfolioRisk})을 초과합니다.`,recommendation:"위험도를 낮추기 위해 포지션을 조정하거나 분산 투자를 고려하세요.",isBlocking:!1}:{id:"portfolio-risk",category:"PORTFOLIO",title:"포트폴리오 위험도",status:"PASS",message:"포트폴리오 위험도가 적절합니다.",isBlocking:!1}}static generateConcentrationWarnings(t,e){const i=[];return t.topPositions.forEach(t=>{"HIGH"===t.risk&&i.push({id:`concentration-${t.symbol}`,type:"HIGH",category:"CONCENTRATION",title:"포지션 집중도 위험",message:`${t.symbol}이 포트폴리오의 ${t.percentage.toFixed(1)}%를 차지합니다.`,recommendation:"포지션 크기를 줄이거나 다른 종목으로 분산하세요.",canProceed:!0})}),i}static generateCashWarnings(t,e){const i=[];return"HIGH"===t.risk&&i.push({id:"cash-risk",type:"HIGH",category:"CASH",title:"현금 부족 위험",message:`현금 비율이 ${t.currentCashRatio.toFixed(1)}%로 매우 낮습니다.`,recommendation:`최소 ${t.recommendedCashRatio}%의 현금을 유지하세요.`,canProceed:!0}),i}static generatePositionWarnings(t,e){const i=[];return t.forEach(t=>{t.riskScore>=8&&i.push({id:`position-risk-${t.symbol}`,type:"HIGH",category:"POSITION",title:"포지션 위험",message:`${t.symbol}의 위험도가 높습니다 (${t.riskScore}/10).`,recommendation:"포지션 크기를 줄이거나 손절을 고려하세요.",canProceed:!0})}),i}static generateRecommendations(t,e,i){const s=[];return t>=7&&s.push("포트폴리오 위험도가 높습니다. 전체적인 리밸런싱을 고려하세요."),e.diversificationScore<5&&s.push("포트폴리오 분산도가 낮습니다. 다양한 종목/섹터에 투자하세요."),"HIGH"===i.risk&&s.push("현금 비율을 높여 안전성을 확보하세요."),s}static calculateOverallRiskScore(t,e,i){let s=5;t.diversificationScore<3?s+=2:t.diversificationScore<5&&(s+=1),"HIGH"===e.risk?s+=2:"MEDIUM"===e.risk&&(s+=1);const a=i.filter(t=>t.riskScore>=7).length;return s+=Math.min(2,a),Math.min(10,Math.max(1,s))}static calculateDiversificationScore(t){return 0===t.length?1:t.length>=10?10:Math.min(10,t.length)}static analyzeSectorConcentration(t,e){return[{sector:"기술",percentage:40,risk:"MEDIUM"},{sector:"금융",percentage:30,risk:"LOW"}]}static getWarningPriority(t){switch(t){case"HIGH":return 1;case"MEDIUM":return 2;case"LOW":return 3;default:return 4}}static createWarningFromCheck(t){return{id:t.id,type:"FAIL"===t.status?"HIGH":"MEDIUM",category:"CASH"===t.category?"CASH":"POSITION"===t.category?"POSITION":"PORTFOLIO"===t.category?"CONCENTRATION":"RULE_VIOLATION",title:t.title,message:t.message,recommendation:t.recommendation||"",canProceed:!t.isBlocking}}}export{r as C,l as E,u as R,n as a};
//# sourceMappingURL=riskManagementService-c38bc133.js.map
